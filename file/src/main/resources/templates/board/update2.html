<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout.html}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> </title>
</head>
<body>
    <div layout:fragment="content">

    
        <form class="actionForm" action="/board/update" method="post">
        <div>
            <label>tno</label>
            <input type="text" name="tno" id="tno" th:value="${list.tno}" readonly>
        </div>

        <div>
            <label>title</label>
            <input type="text" name="title" th:value="${list.title}">
        </div>

        <div>
            <label>content</label>
            <input type="text" name="content" id="content" th:value="${list.content}">
        </div>

        <div>
            <label>writer</label>
            <input type="text" name="writer" id="writer" th:value="${list.writer}">
        </div>

        <div>
            <button class="saveBtn">UPDATE</button>
        </div>
       
    </form>
        
    <input class="uploadInput" type="file" name="upload" multiple>
    <button class="uploadBtn"> UPLOAD </button>

    <div class="uploadDiv">
        <ul class="uploadUL">

        </ul>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>


    <script layout:fragment="script" th:inline="javascript">
        const uploadBtn = document.querySelector(".uploadBtn")
        const uploadInput = document.querySelector(".uploadInput")
        const uploadUL = document.querySelector(".uploadUL")
        const saveBtn = document.querySelector(".saveBtn")
        const actionForm = document.querySelector(".actionForm")

        
        saveBtn.addEventListener("click", e => {
            e.preventDefault()
            e.stopPropagation()
            const liArr = uploadUL.querySelectorAll("li")

            if(!liArr || liArr.length === 0) {
                alert("파일이 없어요")
                return
            }

            let str = ""
            for(let liObj of liArr) {
                const uuid = liObj.getAttribute("data-uuid")
                const fileName = liObj.getAttribute("data-filename")

                str += `<input type='text' name='fileNames' value = '${uuid}_${fileName}'>`

                console.log('str after :', str)
            }
            actionForm.innerHTML += str
            actionForm.submit()
        }, false)


        uploadBtn.addEventListener("click", e => {
            e.preventDefault()
            e.stopPropagation()

            if(!uploadInput.files || uploadInput.files.length === 0 ) {
                return
            }

            const formData = new FormData()

            for(let i=0; i< uploadInput.files.length; i++) {
                formData.append("files", uploadInput.files[i])
            }

            const header = {headers : {"Content-Type" : "multipart/form-data"}}
            axios.post('http://localhost:8084/upload', formData, header)
            .then(res => {
                const result = res.data
                showProducts(result)
            })
        },false)

        const showProducts = (arr) => {
            let str =""

            for(const uploadFile of arr) {
                const{fileName,link,uuid} = uploadFile

                str += `
                <li data-uuid='${uuid}' data-fileName='${fileName}'>
                <div>
                    <a href='http://localhost/${uuid}_${fileName}' target="_blank">
                    <img src='http://localhost/${link}'/>
                    </a>
                    <p>${fileName} <button onclick="javascript:removeFile(event, '${uuid}', '${fileName}')">x</button></p>
                <div>   
                </li>`
            }
            uploadUL.innerHTML += str
        }
        const removeFile = (e, uuid, fileName) => {

        e.stopPropagation()
        e.preventDefault()
        alert("remove file")

        const liObj = e.target.closest("li")

        console.log(liObj)


        axios.delete(`http://localhost:8084/removeFile/${uuid}_${fileName}`)


        liObj.remove()

    }


        </script>
    
</body>
</html>