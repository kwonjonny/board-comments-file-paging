<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/layout.html}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Board Update Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f8f8;
            margin: 0;
        }

        h1 {
            color: #333;
            text-align: center;
        }

        .container-fluid {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            border: none;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .col-form-label {
            font-weight: bold;
        }

        .form-control {
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        textarea.form-control {
            resize: none;
        }

        .btn-primary {
            background-color: #007bff;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-primary:hover {
            background-color: #0069d9;
        }

        .border-top {
            border-top: 1px solid #ddd;
        }

        .card-footer {
            padding: 20px;
        }

        .card-footer .btn-primary {
            margin-right: 10px;
        }

        .d-flex.align-items-center {
            display: flex;
            align-items: center;
        }

        .my-2 {
            margin-top: 2px;
            margin-bottom: 2px;
        }

        .uploadDiv {
            margin-top: 20px;
        }

        .uploadUL {
            list-style-type: none;
            padding: 0;
        }

        .uploadUL li {
            margin-bottom: 10px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
        }

        .uploadHidden {
            display: none;
        }

        .uploadInput {
            display: none;
        }

        .uploadBtn {
            background-color: #28a745;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            text-align: center;
        }

        .uploadBtn:hover {
            background-color: #218838;
        }
    </style>
</head>

<body>
    <!-- Fragment Content Start -->
    <div layout:fragment="content">
        <h1>Board Update Page</h1>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body">

                            <!-- Form Start -->
                            <form class="form-horizontal actionForm" method="post" action="/board/update">

                                <!-- Tno Start -->
                                <div class="form-group row">
                                    <label for="tno" class="col-sm-3 text-end control-label col-form-label">Tno</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" name="tno" id="tno"
                                            th:value="${list.tno}" readonly />
                                    </div>
                                </div>
                                <!-- Tno End -->

                                <!-- Title Start -->
                                <div class="form-group row">
                                    <label for="title"
                                        class="col-sm-3 text-end control-label col-form-label">Title</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" name="title" id="title"
                                            th:value="${list.title}" />
                                    </div>
                                </div>
                                <!-- Title End -->

                                <!-- Writer Start -->
                                <div class="form-group row">
                                    <label for="writer"
                                        class="col-sm-3 text-end control-label col-form-label">Writer</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" name="writer" id="writer"
                                            th:value="${list.writer}" />
                                    </div>
                                </div>
                                <!-- Writer End -->

                                <!-- Regist Date Start -->
                                <div class="form-group row">
                                    <label for="registDate"
                                        class="col-sm-3 text-end control-label col-form-label">Regist Date</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" name="registDate" id="registDate"
                                            th:value="${list.registDate}" readonly />
                                    </div>
                                </div>
                                <!-- Regist Date End -->

                                <!-- Update Date Start -->
                                <div class="form-group row">
                                    <label for="modifyDate"
                                        class="col-sm-3 text-end control-label col-form-label">Update Date</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" name="modifyDate" id="modifyDate"
                                            th:value="${list.updateDate}" readonly />
                                    </div>
                                </div>
                                <!-- Update Date End -->

                                <!-- Content Start -->
                                <div class="form-group row">
                                    <label for="content"
                                        class="col-sm-3 text-end control-label col-form-label">Content</label>
                                    <div class="col-sm-9">
                                        <textarea class="form-control" name="content" id="content"
                                            th:text="${list.content}"></textarea>
                                    </div>
                                </div>
                                <!-- Content End -->


                                <!-- Upload Start -->
                                <div>
                                    <input class="uploadInput" type="file" name="upload" multiple>
                                    <button class="uploadBtn">UPLOAD</button>
                                </div>
                                <!-- Upload End -->

                                <!-- 파일 띄워주기 Start -->
                                <div class="uploadDiv">
                                    <ul class="uploadUL">

                                    </ul>
                                </div>
                                <!-- 파일 띄워주기 End -->

                                <!-- Update Button Start -->
                                <div class="border-top">
                                    <div class="card-body">
                                        <button type="button" class="btn btn-primary saveBtn">게시글 수정 submit</button>
                                    </div>
                                </div>
                                <div class="uploadHidden">

                                </div>
                                <!-- Update Button End -->

                            </form>
                            <!-- Form End -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    </div>
    <!-- Fragment Content End -->

    <!-- JavaScript Start -->
    <script layout:fragment="script" th:inline="javascript">

        const fileNames = [[${ list.fileName }]];
        console.log('fileNames', fileNames)


        // actionForm 등록 
        const actionForm = document.querySelector(".actionForm");
        // actionUpdate 등록 
        const saveBtn = document.querySelector(".saveBtn")

        // fileUpload 등록 
        const uploadBtn = document.querySelector(".uploadBtn")
        const uploadInput = document.querySelector(".uploadInput")
        const uploadUL = document.querySelector(".uploadUL")
        const uploadHidden = document.querySelector(".uploadHidden")
        const tno = [[${ list.tno }]]

        // Update Action Method Start 
        saveBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            // 사용자가 업데이트 요청시 파일의 값을 Server 로 보내줍니다 
            const liArr = uploadUL.querySelectorAll("li")
            if (!liArr || liArr.length === 0) {
                alert("파일이 없어요")
                return
            }

            let str = ""
            for (let liObj of liArr) {
                const uuid = liObj.getAttribute("data-uuid")
                const fileName = liObj.getAttribute("data-filename")
                str += `<input type='text' name='fileNames' value = '${uuid}_${fileName}'>`
            }

            uploadHidden.innerHTML += str
            actionForm.submit();
        }, false)

        // 사용자가 업로드 버튼 클릭시 post 요청 Enginx
        uploadBtn.addEventListener("click", e => {
            e.preventDefault()
            e.stopPropagation()
            if (!uploadInput.files || uploadInput.files.length === 0) {
                return
            }
            const formData = new FormData()
            for (let i = 0; i < uploadInput.files.length; i++) {
                formData.append("files", uploadInput.files[i])
            }
            const header = { headers: { "Content-Type": "multipart/form-data" } }
            axios.post('http://localhost:8084/upload', formData, header)
                .then(res => {
                    const result = res.data
                    showProducts(result)
                })
        }, false)

        // 사용자가 upload 버튼을 눌렀을시에 사진을 보여줍니다 
        const showProducts = (arr) => {
            let str = ""
            for (const uploadFile of arr) {
                const { fileName, link, uuid } = uploadFile

                str += `
                <li data-uuid='${uuid}' data-fileName='${fileName}'>
                <div>
                    <a href='http://localhost/${uuid}_${fileName}' target="_blank">
                    <img src='http://localhost/${link}'/>
                    </a>
                    <p>${fileName} <button onclick="javascript:removeFile(event, '${uuid}', '${fileName}')">x</button></p>
                <div>   
                </li>
                `
            }
            uploadUL.innerHTML += str
        }

        // 사용자가 removeButton 을 클릭시에 post요청을보내고 사진을 삭제합니다 
        const removeFile = (e, uuid, fileName) => {
            e.preventDefault()
            e.stopPropagation()
            const liObj = e.target.closest("li")
            axios.delete(`http://localhost:8084/removeFile/${uuid}_${fileName}`)
            liObj.remove()
        }


        // 파일 이름 배열을 변환하는 함수
        const loadImages = (fileNames) => {
            // fileNames 배열을 uuid, fileName, link 형태의 객체로 변환
            const objArr = fileNames.map(str => {
                const uuid = str.substring(0, 36);
                const fileName = str.substring(37);
                const link = 's_' + str;
                return { uuid, fileName, link };
            });

            // 변환된 배열을 showProducts 함수에 전달
            showProducts(objArr);
        };

        loadImages(fileNames)




        // JavaScript End
    </script>
</body>

</html>